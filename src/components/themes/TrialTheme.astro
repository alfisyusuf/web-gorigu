---
import { urlFor } from "../../utils/image";

const { data } = Astro.props;

// Logic Data: Menentukan Urutan Judul
const isPriaFirst = data.nameOrder !== 'wanitaFirst';
const namaPertama = isPriaFirst ? data.priaNickname : data.wanitaNickname;
const namaKedua = isPriaFirst ? data.wanitaNickname : data.priaNickname;
const tanggalAkad = new Date(data.akadDate).toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

// Ambil URL Gambar Cover
const coverUrl = data.coverImage 
  ? urlFor(data.coverImage).width(800).height(1200).url() 
  : 'https://placehold.co/800x1200/333/fff?text=Upload+Cover';

// --- LOGIKA SWAPPING (TUKAR POSISI) ---

// 1. Siapkan URL Foto
const priaFotoUrl = data.priaFoto ? urlFor(data.priaFoto).width(400).height(400).url() : 'https://placehold.co/400';
const wanitaFotoUrl = data.wanitaFoto ? urlFor(data.wanitaFoto).width(400).height(400).url() : 'https://placehold.co/400';

// 2. Bungkus Data Pria & Wanita jadi Object
const groomData = {
    name: data.priaName,
    parents: data.priaParents,
    ig: data.priaIg,
    foto: priaFotoUrl,
    label: 'Putra dari' // Label statis
};

const brideData = {
    name: data.wanitaName,
    parents: data.wanitaParents,
    ig: data.wanitaIg,
    foto: wanitaFotoUrl,
    label: 'Putri dari' // Label statis
};

// 3. Tentukan siapa yang render duluan (First & Second)
const first = isPriaFirst ? groomData : brideData;
const second = isPriaFirst ? brideData : groomData;

const backgroundStyle = `background-image: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('${coverUrl}');`;
---

<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wedding of {namaPertama} & {namaKedua}</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;1,400&family=Poppins:wght@300;500&display=swap" rel="stylesheet">
    
    <style>
        body { margin: 0; font-family: 'Poppins', sans-serif; overflow: hidden; background-color: #333; }
        
        .cover-screen {
            height: 100vh;
            width: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: white;
            background-size: cover;
            background-position: center top;
            transition: all 0.5s ease;
        }
            
        h1 { font-family: 'Playfair Display', serif; font-size: 3.5rem; margin: 0; line-height: 1.2; text-shadow: 2px 2px 10px rgba(0,0,0,0.5); }
        .guest-box { margin: 40px 40px 0 40px; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(5px); padding: 15px 30px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.3);}
        .btn-open { margin-top: 30px; background: white; color: #333; border: none; padding: 12px 30px; border-radius: 50px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        
        /* Countdown */
        .countdown-box { display: flex; gap: 15px; margin-top: 30px; }
        .cd-item { text-align: center; }
        .cd-num { font-size: 1.5rem; font-weight: bold; }
        .cd-label { font-size: 0.6rem; text-transform: uppercase; }

        #main-content { display: none; background: white; color: black; padding: 50px 20px; text-align: center; min-height: 100vh;}

        /* CSS Section Lainnya (Quote, Couple, dll) */
        section { padding: 50px 20px; text-align: center; }
        .container { max-width: 800px; margin: 0 auto; }
        h2 { font-family: 'Playfair Display', serif; font-size: 2.2rem; color: #333; margin-bottom: 25px; }
        p { color: #555; line-height: 1.6; font-size: 0.95rem; margin-bottom: 15px; }
        .divider { font-size: 2rem; color: #ddd; margin: 20px 0; font-family: 'Playfair Display', serif; }
        .quote-section { background-color: #f9f9f9; }
        .quote-text { font-style: italic; font-size: 1rem; color: #444; }
        .couple-wrapper { display: flex; flex-direction: column; gap: 40px; margin-top: 30px; align-items: center; }
        .mempelai-card { width: 100%; max-width: 350px; }
        .mempelai-img { width: 160px; height: 160px; border-radius: 50%; object-fit: cover; margin-bottom: 15px; border: 3px solid #ccc; }
        .mempelai-name { font-family: 'Playfair Display', serif; font-size: 1.6rem; font-weight: bold; margin: 5px 0; color: #222; }
        .ortu-name { font-size: 0.9rem; color: #777; }
        .ig-link { display: inline-block; margin-top: 8px; font-size: 0.85rem; text-decoration: none; color: #555; background: #eee; padding: 4px 12px; border-radius: 15px; }
        .event-grid { display: grid; gap: 20px; margin-top: 20px; }
        .event-card { background: #fff; border: 1px solid #eee; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .event-title { font-family: 'Playfair Display', serif; font-size: 1.5rem; color: #333; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px; display: inline-block; }
        .btn-maps { background-color: #333; color: #fff; text-decoration: none; padding: 10px 20px; border-radius: 50px; display: inline-block; margin-top: 15px; font-size: 0.9rem; transition: background 0.3s; }
        .btn-maps:hover { background-color: #000; }
        .gallery-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 20px; }
        .gallery-img { width: 100%; height: 200px; object-fit: cover; border-radius: 8px; cursor: pointer; }
        .gift-section { background-color: #f4f4f4; }
        .bank-card { background: white; padding: 20px; border-radius: 10px; margin: 15px auto; max-width: 400px; border: 1px solid #ddd; display: flex; flex-direction: column; align-items: center; }
        .rek-number { font-size: 1.3rem; font-weight: bold; margin: 10px 0; letter-spacing: 1px; font-family: monospace; }
        .btn-copy { background: none; border: 1px solid #888; padding: 5px 15px; border-radius: 20px; cursor: pointer; font-size: 0.8rem; margin-top: 5px; }

        @media (min-width: 768px) {
            .couple-wrapper { flex-direction: row; justify-content: center; align-items: flex-start; }
            .event-grid { grid-template-columns: repeat(2, 1fr); }
            .gallery-grid { grid-template-columns: repeat(3, 1fr); }
            .cover-screen { background-position: center 20%; }
        }
    </style>
</head>
<body>

    <div class="cover-screen" id="cover" style={backgroundStyle}>
        
        <p style="letter-spacing: 3px; font-size: 0.9rem; margin-bottom: 10px; opacity: 0.9;">THE WEDDING OF</p>
        
        <h1>{namaPertama} <br> <span style="font-size: 2rem; font-style: italic;">&</span> <br> {namaKedua}</h1>
        
        <p style="margin-top: 10px; font-weight: 300;">{tanggalAkad}</p>

        <div class="countdown-box" id="countdown">
            <div class="cd-item"><span class="cd-num" id="d">0</span><span class="cd-label">Hari</span></div>
            <div class="cd-item"><span class="cd-num" id="h">0</span><span class="cd-label">Jam</span></div>
            <div class="cd-item"><span class="cd-num" id="m">0</span><span class="cd-label">Menit</span></div>
            <div class="cd-item"><span class="cd-num" id="s">0</span><span class="cd-label">Detik</span></div>
        </div>

        <div class="guest-box">
            <small style="opacity: 0.8;">Kepada Yth. Bapak/Ibu/Saudara/i:</small>
            <h3 id="nama-tamu" style="margin: 5px 0 0 0;">Tamu Undangan</h3>
        </div>

        <button class="btn-open" id="tombol-buka">
            üíå Buka Undangan
        </button>
    </div>

    <div id="main-content">
        
        {data.quote && (
            <section class="quote-section">
                <div class="container">
                    <p class="quote-text">"{data.quote}"</p>
                </div>
            </section>
        )}

        <section id="mempelai">
            <div class="container">
                <h2>Mempelai</h2>
                <p>Dengan memohon rahmat dan ridho Allah SWT, kami bermaksud menyelenggarakan pernikahan putra-putri kami:</p>

                <div class="couple-wrapper">
                    <div class="mempelai-card">
                        <img 
                            src={first.foto} 
                            alt={first.name} 
                            class="mempelai-img"
                        />
                        <div class="mempelai-name">{first.name}</div>
                        <div class="ortu-name">{first.label} {first.parents}</div>
                        
                        {first.ig && (
                            <a href={`https://instagram.com/${first.ig}`} target="_blank" class="ig-link">
                                @{first.ig}
                            </a>
                        )}
                    </div>

                    <div class="divider">&</div>

                    <div class="mempelai-card">
                        <img 
                            src={second.foto} 
                            alt={second.name} 
                            class="mempelai-img"
                        />
                        <div class="mempelai-name">{second.name}</div>
                        <div class="ortu-name">{second.label} {second.parents}</div>
                        
                        {second.ig && (
                            <a href={`https://instagram.com/${second.ig}`} target="_blank" class="ig-link">
                                @{second.ig}
                            </a>
                        )}
                    </div>
                </div>
            </div>
        </section>

        <section id="acara" style="background-color: #fffaf0;">
            <div class="container">
                <h2>Rangkaian Acara</h2>
                <div class="event-grid">
                    
                    <div class="event-card">
                        <span class="event-title">Akad Nikah</span>
                        <p style="font-weight: bold; font-size: 1.1rem;">
                            {new Date(data.akadDate).toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}
                        </p>
                        <p>üïó {data.akadTimeManual ? data.akadTimeManual : new Date(data.akadDate).toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'}) + ' WIB'}</p>
                        
                        <p style="margin-top: 15px;"><strong>{data.akadPlace}</strong></p>
                        <p style="font-size: 0.85rem;">{data.akadAddress}</p>
                        
                        {data.akadMaps && (
                            <a href={data.akadMaps} target="_blank" class="btn-maps">üìç Google Maps</a>
                        )}
                    </div>

                    {data.resepsiDate && (
                    <div class="event-card">
                        <span class="event-title">Resepsi</span>
                        <p style="font-weight: bold; font-size: 1.1rem;">
                            {new Date(data.resepsiDate).toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}
                        </p>
                        <p>üïö {data.resepsiTimeManual ? data.resepsiTimeManual : new Date(data.resepsiDate).toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'}) + ' WIB'}</p>
                        
                        <p style="margin-top: 15px;"><strong>{data.resepsiPlace}</strong></p>
                        <p style="font-size: 0.85rem;">{data.resepsiAddress}</p>
                        
                        {data.resepsiMaps && (
                            <a href={data.resepsiMaps} target="_blank" class="btn-maps">üìç Google Maps</a>
                        )}
                    </div>
                    )}

                </div>
            </div>
        </section>

        {data.gallery && data.gallery.length > 0 && (
            <section id="galeri">
                <div class="container">
                    <h2>Galeri Foto</h2>
                    <div class="gallery-grid">
                        {data.gallery.map((image: any) => (
                            <img 
                                src={urlFor(image).width(400).height(400).url()} 
                                alt="Gallery Wedding" 
                                class="gallery-img" 
                                loading="lazy"
                            />
                        ))}
                    </div>
                    {data.videoLink && (
                        <div style="margin-top: 30px;">
                            <a href={data.videoLink} target="_blank" style="text-decoration: underline;">Tonton Video Wedding</a>
                        </div>
                    )}
                </div>
            </section>
        )}

        {data.bankAccounts && data.bankAccounts.length > 0 && (
            <section class="gift-section" id="kado">
                <div class="container">
                    <h2>Tanda Kasih</h2>
                    <p>Tanpa mengurangi rasa hormat, bagi Anda yang ingin memberikan tanda kasih untuk mempelai, dapat melalui:</p>
                    
                    {data.bankAccounts.map((bank: any) => (
                        <div class="bank-card">
                            <span style="font-weight: bold; text-transform: uppercase;">{bank.bankName}</span>
                            <span class="rek-number">{bank.accountNumber}</span>
                            <span style="font-size: 0.9rem;">a.n {bank.accountName}</span>
                            <button class="btn-copy" onclick={`navigator.clipboard.writeText('${bank.accountNumber}').then(() => alert('Nomor rekening disalin!'))`}>
                                üìã Salin
                            </button>
                        </div>
                    ))}

                    {data.giftAddress && (
                        <div style="margin-top: 20px; font-size: 0.9rem;">
                            <strong>Alamat Kirim Kado:</strong><br/>
                            {data.giftAddress}
                        </div>
                    )}
                </div>
            </section>
        )}

        <footer style="background: #333; color: white; padding: 40px 20px; text-align: center;">
            <p style="color: #ccc; margin: 0;">Wedding of {namaPertama} & {namaKedua}</p>
            <small style="color: #888;">Created with ‚ù§Ô∏è by Gorigu</small>
        </footer>
    </div>

    <audio id="bg-music" loop preload="auto">
        <source src={`/music/${data.music || 'default.mp3'}`} type="audio/mpeg">
    </audio>

    <script is:inline define:vars={{ targetDate: data.akadDate }}>
        // 1. Ambil Parameter Nama Tamu
        const params = new URLSearchParams(window.location.search);
        const tamu = params.get('tamu');
        if(tamu) document.getElementById('nama-tamu').innerText = tamu;

        // 2. Logic Tombol Buka Undangan + Musik
        const tombolBuka = document.getElementById('tombol-buka');
        const coverScreen = document.getElementById('cover');
        const mainContent = document.getElementById('main-content');
        const audio = document.getElementById('bg-music');

        if(tombolBuka) {
            tombolBuka.addEventListener('click', function() {
                // Hilangkan Cover, Munculkan Isi
                coverScreen.style.display = 'none';
                mainContent.style.display = 'block';
                document.body.style.overflow = 'auto';

                // Play Music
                if(audio) {
                    audio.play()
                    .then(() => console.log("Audio playing"))
                    .catch(e => console.log("Gagal memutar audio:", e));
                }
            });
        }

        // 3. Logic Countdown
        const countDownDate = new Date(targetDate).getTime();
        setInterval(function() {
            const now = new Date().getTime();
            const distance = countDownDate - now;
            if (distance >= 0) {
                document.getElementById("d").innerText = Math.floor(distance / (1000 * 60 * 60 * 24));
                document.getElementById("h").innerText = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                document.getElementById("m").innerText = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                document.getElementById("s").innerText = Math.floor((distance % (1000 * 60)) / 1000);
            }
        }, 1000);
    </script>
</body>
</html>