---
import { urlFor } from "../../utils/image";

const { data } = Astro.props;

// --- LOGIC UTAMA ---

// 1. Urutan Nama
const isPriaFirst = data.nameOrder !== 'wanitaFirst';
const namaPertama = isPriaFirst ? data.priaNickname : data.wanitaNickname;
const namaKedua = isPriaFirst ? data.wanitaNickname : data.priaNickname;
const namaLengkapPertama = isPriaFirst ? data.priaName : data.wanitaName;
const namaLengkapKedua = isPriaFirst ? data.wanitaName : data.priaName;
const ortuPertama = isPriaFirst ? data.priaParents : data.wanitaParents;
const ortuKedua = isPriaFirst ? data.wanitaParents : data.priaParents;
const fotoPertama = isPriaFirst ? data.priaFoto : data.wanitaFoto;
const fotoKedua = isPriaFirst ? data.wanitaFoto : data.priaFoto;

// 2. Format Waktu
const waktuAkad = data.akadTimeManual || new Date(data.akadDate).toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'}) + ' WIB';
const waktuResepsi = data.resepsiTimeManual || new Date(data.resepsiDate).toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'}) + ' WIB';

const tanggalAkad = new Date(data.akadDate).toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
const tanggalResepsi = new Date(data.resepsiDate).toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

// 3. Gambar Cover (Placeholder jika kosong)
const coverUrl = data.coverImage 
  ? urlFor(data.coverImage).width(800).height(1200).url() 
  : 'https://placehold.co/800x1200/eee/333?text=No+Cover+Image';

// 4. Proses Galeri (Mengambil URL untuk setiap foto)
const galleryImages = data.gallery?.map((img: any) => urlFor(img).width(400).height(400).url()) || [];
---

<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Wedding of {namaPertama} & {namaKedua}</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style define:vars={{ coverUrl }}>
        body { margin: 0; font-family: 'Montserrat', sans-serif; background: #f9f9f9; color: #444; }
        .container { max-width: 480px; margin: 0 auto; background: white; min-height: 100vh; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        
        /* HERO / COVER */
        .hero {
            height: 100vh; position: relative;
            display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: white;
            background-image: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.6)), url(var(--coverUrl));
            background-size: cover; background-position: center;
        }
        .hero h1 { font-family: 'Cormorant Garamond', serif; font-size: 3.5rem; margin: 10px 0; line-height: 1; }
        .hero p { letter-spacing: 2px; text-transform: uppercase; font-size: 0.8rem; margin-bottom: 20px;}
        
        /* COUNTDOWN */
        .countdown { display: flex; gap: 10px; margin-top: 20px; }
        .time-box { background: rgba(255,255,255,0.2); padding: 8px 12px; border-radius: 6px; min-width: 50px; backdrop-filter: blur(2px); }
        .time-val { font-size: 1.2rem; font-weight: bold; display: block; }
        .time-label { font-size: 0.6rem; text-transform: uppercase; }

        /* NAMA TAMU */
        .guest-box { margin-top: 30px; background: rgba(255,255,255,0.9); color: #333; padding: 15px 30px; border-radius: 50px; }
        
        /* CONTENT SECTIONS */
        .section { padding: 50px 25px; text-align: center; }
        .bg-gray { background-color: #fcfcfc; }
        
        h2 { font-family: 'Cormorant Garamond', serif; font-size: 2.5rem; color: #222; margin-bottom: 30px; }
        .mempelai-card { margin-bottom: 40px; }
        .avatar { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; margin-bottom: 15px; border: 3px solid #eee; }
        
        .event-card { border: 1px solid #eee; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .btn-maps { display: inline-block; margin-top: 10px; text-decoration: none; background: #333; color: white; padding: 8px 20px; border-radius: 4px; font-size: 0.8rem; }

        /* GALERI GRID */
        .gallery-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .gallery-img { width: 100%; height: 150px; object-fit: cover; border-radius: 4px; }

        /* AMPLOP */
        .bank-card { background: #f4f4f4; padding: 15px; border-radius: 8px; margin-bottom: 10px; text-align: left; }
        .copy-btn { float: right; font-size: 0.8rem; cursor: pointer; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <div class="hero">
            <p>The Wedding Of</p>
            <h1>{namaPertama} & {namaKedua}</h1>
            <p>{tanggalAkad}</p>

            <div id="countdown" class="countdown">
                <div class="time-box"><span class="time-val" id="d">0</span><span class="time-label">Hari</span></div>
                <div class="time-box"><span class="time-val" id="h">0</span><span class="time-label">Jam</span></div>
                <div class="time-box"><span class="time-val" id="m">0</span><span class="time-label">Menit</span></div>
                <div class="time-box"><span class="time-val" id="s">0</span><span class="time-label">Detik</span></div>
            </div>

            <div class="guest-box">
                <small>Kepada Yth:</small>
                <h3 id="nama-tamu" style="margin: 5px 0 0 0;">Tamu Undangan</h3>
            </div>
        </div>

        <div class="section">
            <p style="font-style: italic; color: #666;">"{data.quote || "Dan Kami menciptakan kamu berpasang-pasangan."}"</p>
            <br>
            <h2>Mempelai</h2>
            
            <div class="mempelai-card">
                {fotoPertama && <img src={urlFor(fotoPertama).width(300).height(300).url()} class="avatar" alt="Mempelai 1" />}
                <h3 style="margin:0; font-size: 1.5rem;">{namaLengkapPertama}</h3>
                <p style="font-size: 0.8rem; color: #666; margin-top: 5px;">{ortuPertama}</p>
                {/* Akses dinamis field IG, hati-hati krn nama field beda tergantung urutan */}
                {isPriaFirst && data.priaIg && <p style="font-size: 0.8rem;">üì∏ @{data.priaIg}</p>}
                {!isPriaFirst && data.wanitaIg && <p style="font-size: 0.8rem;">üì∏ @{data.wanitaIg}</p>}
            </div>

            <h1 style="font-family: 'Cormorant Garamond'; font-size: 3rem; color: #ccc;">&</h1>

            <div class="mempelai-card">
                {fotoKedua && <img src={urlFor(fotoKedua).width(300).height(300).url()} class="avatar" alt="Mempelai 2" />}
                <h3 style="margin:0; font-size: 1.5rem;">{namaLengkapKedua}</h3>
                <p style="font-size: 0.8rem; color: #666; margin-top: 5px;">{ortuKedua}</p>
                {isPriaFirst && data.wanitaIg && <p style="font-size: 0.8rem;">üì∏ @{data.wanitaIg}</p>}
                {!isPriaFirst && data.priaIg && <p style="font-size: 0.8rem;">üì∏ @{data.priaIg}</p>}
            </div>
        </div>

        <div class="section bg-gray">
            <h2>Rangkaian Acara</h2>
            
            <div class="event-card">
                <h3>Akad Nikah</h3>
                <p>üìÖ {tanggalAkad}</p>
                <p>‚è∞ {waktuAkad}</p>
                <p>üìç {data.akadPlace}</p>
                <p style="font-size: 0.8rem; color: #666;">{data.akadAddress}</p>
                {data.akadMaps && <a href={data.akadMaps} target="_blank" class="btn-maps">Google Maps</a>}
            </div>

            <div class="event-card">
                <h3>Resepsi</h3>
                <p>üìÖ {tanggalResepsi}</p>
                <p>‚è∞ {waktuResepsi}</p>
                <p>üìç {data.resepsiPlace}</p>
                <p style="font-size: 0.8rem; color: #666;">{data.resepsiAddress}</p>
                {data.resepsiMaps && <a href={data.resepsiMaps} target="_blank" class="btn-maps">Google Maps</a>}
            </div>
        </div>

        {galleryImages.length > 0 && (
            <div class="section">
                <h2>Galeri Momen</h2>
                <div class="gallery-grid">
                    {galleryImages.map((imgUrl: string) => (
                        <img src={imgUrl} class="gallery-img" loading="lazy" />
                    ))}
                </div>
            </div>
        )}

        <div class="section bg-gray">
            <h2>Wedding Gift</h2>
            <p style="font-size: 0.9rem; margin-bottom: 20px;">Doa restu Anda merupakan karunia yang sangat berarti bagi kami. Dan jika memberi adalah ungkapan tanda kasih Anda, Anda dapat memberi kado secara cashless.</p>
            
            {data.bankAccounts && data.bankAccounts.map((bank: any) => (
                <div class="bank-card">
                    <span style="font-weight: bold;">{bank.bankName}</span>
                    <span class="copy-btn" onclick={`navigator.clipboard.writeText('${bank.accountNumber}')`}>Salin</span>
                    <p style="font-size: 1.2rem; margin: 5px 0;">{bank.accountNumber}</p>
                    <p style="font-size: 0.8rem;">a.n {bank.accountName}</p>
                </div>
            ))}
        </div>

        <audio autoplay loop id="bg-music">
            <source src={`/music/${data.music || 'lagu1.mp3'}`} type="audio/mpeg">
        </audio>

    </div>

    <script is:inline define:vars={{ targetDate: data.akadDate }}>
        // COUNTDOWN
        const countDownDate = new Date(targetDate).getTime();
        const x = setInterval(function() {
            const now = new Date().getTime();
            const distance = countDownDate - now;
            if (distance < 0) {
                clearInterval(x);
                document.getElementById("countdown").innerHTML = "<div>ACARA TELAH DIMULAI</div>";
                return;
            }
            document.getElementById("d").innerText = Math.floor(distance / (1000 * 60 * 60 * 24));
            document.getElementById("h").innerText = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            document.getElementById("m").innerText = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            document.getElementById("s").innerText = Math.floor((distance % (1000 * 60)) / 1000);
        }, 1000);

        // NAMA TAMU
        const params = new URLSearchParams(window.location.search);
        const tamu = params.get('tamu');
        if(tamu) document.getElementById('nama-tamu').innerText = tamu;
    </script>
</body>
</html>